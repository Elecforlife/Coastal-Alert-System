<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coastal Alert — Dashboard</title>
  <style>
    :root{--bg:#0f1724;--card:#111827;--muted:#9ca3af;--accent:#06b6d4;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071029 0%, #041226 100%);display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:720px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,.6);color:#e6eef6}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#052025;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted)}
    .result{margin-top:18px;padding:14px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
    .line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.02)}
    .line:last-child{border-bottom:none}
    .muted{color:var(--muted);font-size:13px}
    .foot{margin-top:16px;color:var(--muted);font-size:13px}
    .status{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600}
    .ok{background:rgba(34,197,94,.12);color:#8ef3b1}
    .warn{background:rgba(250,204,21,.09);color:#ffeaa7}
    .danger{background:rgba(239,68,68,.09);color:#ffb3b3}
  </style>
</head>
<body>
  <div class="card">
    <h1>Coastal Alert — Live</h1>
    <p class="lead">Small single-file UI to call your n8n webhook and display Gemini predictions for tsunami, cyclone and sea-level rise.</p>

    <div class="row">
      <input id="city" type="text" placeholder="Enter city (e.g. Mumbai)" value="Mumbai" />
      <button id="fetchBtn">Get Alert</button>
      <button id="autoBtn" class="secondary">Auto: Off</button>
    </div>

    <div class="result" id="result">
      <div class="muted">No data yet — click <strong>Get Alert</strong> or enable auto-refresh.</div>
    </div>

    <div class="foot">⚠️ Replace <code>WEBHOOK_URL</code> in the code with your n8n webhook URL (or public endpoint). If your workflow uses a Manual Trigger, replace it with a Webhook trigger that accepts a POST with JSON: <code>{"City":"Mumbai"}</code>.</div>
  </div>

  <script>
    // -------------------------
    // CONFIG
    // -------------------------
    // 1) Replace this with your n8n webhook URL (must be public / reachable by the browser)
    // 2) The webhook should accept POST JSON like: { "City": "Mumbai" }
    // 3) The webhook should respond with JSON containing:
    //    { "Tsunami": 12, "Cyclone": 35, "Rise in Sea level": "low rise" }
    //    (or a similar object). The UI will try to display keys it finds.
    const WEBHOOK_URL = 'https://your-n8n.example.com/webhook/coastal-alert';

    // -------------------------
    // Helper + UI code
    // -------------------------
    const cityEl = document.getElementById('city');
    const fetchBtn = document.getElementById('fetchBtn');
    const resultEl = document.getElementById('result');
    const autoBtn = document.getElementById('autoBtn');

    let auto = false;
    let autoInterval = null;

    function renderStatus(score){
      if (typeof score !== 'number') return `<span class="status ok">N/A</span>`;
      if (score >= 70) return `<span class="status danger">High (${score})</span>`;
      if (score >= 30) return `<span class="status warn">Medium (${score})</span>`;
      return `<span class="status ok">Low (${score})</span>`;
    }

    function renderResult(data){
      if (!data) return '<div class="muted">No result returned.</div>';
      // If response is a string containing newline-separated fields, attempt to parse
      if (typeof data === 'string'){
        const lines = data.split('\n').map(s=>s.trim()).filter(Boolean);
        const obj = {};
        lines.forEach(l=>{
          const parts = l.split(':');
          if (parts.length>=2) obj[parts[0].trim()] = parts.slice(1).join(':').trim();
        });
        data = obj;
      }

      // If json contains nested fields, try to find the most relevant object
      if (Array.isArray(data) && data.length>0) data = data[0];

      const keys = Object.keys(data);
      if (keys.length===0) return '<div class="muted">Empty result.</div>';

      let html = '';
      keys.forEach(k=>{
        const v = data[k];
        // parse numeric values if possible
        const n = (typeof v === 'string')?parseFloat(v.replace(/[^
0-9.-]/g,'')):v;
        html += `<div class="line"><div><strong>${k}</strong><div class="muted">${typeof v === 'object'?JSON.stringify(v):v}</div></div><div>${renderStatus(isNaN(n)?undefined:n)}</div></div>`;
      });
      return html;
    }

    async function fetchAlert(){
      const city = cityEl.value.trim() || 'Mumbai';
      if (!WEBHOOK_URL || WEBHOOK_URL.includes('your-n8n')){
        resultEl.innerHTML = '<div class="muted">Please configure <code>WEBHOOK_URL</code> in the script before using.</div>';
        return;
      }

      resultEl.innerHTML = '<div class="muted">Fetching...</div>';

      try{
        const resp = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ City: city })
        });

        const text = await resp.text();
        let data;
        try{ data = JSON.parse(text); } catch(e){ data = text; }

        resultEl.innerHTML = renderResult(data);
      } catch(err){
        resultEl.innerHTML = `<div class="muted">Request failed: ${err.message}</div>`;
      }
    }

    fetchBtn.addEventListener('click', fetchAlert);
    autoBtn.addEventListener('click', ()=>{
      auto = !auto;
      autoBtn.textContent = `Auto: ${auto? 'On' : 'Off'}`;
      if (auto){
        autoInterval = setInterval(fetchAlert, 60_000); // every 60s
        fetchAlert();
      } else {
        clearInterval(autoInterval);
      }
    });

    // Optional: load initial data
    // fetchAlert();
  </script>
</body>
</html>
